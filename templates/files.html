<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Manager - TVB</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Base styles from dashboard */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* Nav */
        .top-nav {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 16px; background: rgba(0,0,0,0.35);
            border-radius: 12px; margin-bottom: 20px;
        }
        .top-nav .brand { font-weight: 700; color: #fff; text-decoration: none; }
        .nav-links a {
            color: #fff; text-decoration: none; font-size: 14px;
            padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.08);
            margin-left: 5px;
        }
        .nav-links a:hover, .nav-links a.active { background: rgba(255,255,255,0.25); }

        /* File List */
        .file-manager {
            background: rgba(0,0,0,0.4); backdrop-filter: blur(10px);
            border-radius: 12px; padding: 20px;
        }
        .toolbar {
            display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .btn {
            padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;
            font-size: 14px; color: #fff; background: rgba(255,255,255,0.1);
            transition: 0.2s;
        }
        .btn:hover { background: rgba(255,255,255,0.2); }
        .btn-primary { background: #667eea; }
        .btn-primary:hover { background: #5a6fd1; }
        .btn-danger { background: rgba(220,53,69,0.4); }
        
        .file-list { display: flex; flex-direction: column; gap: 8px; }
        .file-item {
            display: flex; align-items: center; padding: 12px;
            background: rgba(255,255,255,0.05); border-radius: 8px;
            transition: 0.2s;
        }
        .file-item:hover { background: rgba(255,255,255,0.1); }
        .file-checkbox { margin-right: 15px; transform: scale(1.2); }
        .file-icon { font-size: 24px; margin-right: 15px; }
        .file-info { flex: 1; min-width: 0; }
        .file-name { font-weight: 500; margin-bottom: 4px; overflow:hidden; text-overflow:ellipsis; }
        .file-meta { font-size: 12px; color: #aaa; }
        .file-actions { display: flex; gap: 8px; }

        /* Upload Area */
        .upload-area {
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 8px; padding: 30px; text-align: center;
            margin-bottom: 20px; cursor: pointer; transition: 0.2s;
        }
        .upload-area:hover { border-color: #fff; background: rgba(255,255,255,0.05); }
        
        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #2d3748; padding: 24px; border-radius: 12px; width: 90%; max-width: 400px;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="top-nav">
            <a class="brand" href="/dashboard/{{ user_id }}">TVB</a>
            <div class="nav-links">
                <a href="/dashboard/{{ user_id }}">ëŒ€ì‹œë³´ë“œ</a>
                <a href="/gallery/{{ user_id }}">ê°¤ëŸ¬ë¦¬</a>
                <a href="/encoded/{{ user_id }}">ì¸ì½”ë”©ë¨</a>
                <a href="/files/{{ user_id }}" class="active">íŒŒì¼</a>
                <a href="/search?user_id={{ user_id }}">ê²€ìƒ‰</a>
                <a href="/download?user_id={{ user_id }}">ë‹¤ìš´ë¡œë“œ/ì—…ë¡œë“œ</a>
            </div>
        </nav>

        <div class="file-manager">
            <div class="upload-area" id="drop-zone">
                <div style="font-size: 32px; margin-bottom: 10px;">ğŸ“¤</div>
                <p>íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
                <input type="file" id="file-input" multiple style="display: none;">
            </div>

            <div class="toolbar">
                <button class="btn btn-primary" onclick="requestMultiDownload()">ì„ íƒ ë‹¤ìš´ë¡œë“œ (Zip)</button>
                <button class="btn btn-danger" onclick="deleteSelected()">ì„ íƒ ì‚­ì œ</button>
                <span style="flex:1"></span>
                <span id="status-msg"></span>
            </div>

            <div class="file-list">
                {% if files %}
                    {% for file in files %}
                    <div class="file-item">
                        <input type="checkbox" class="file-checkbox" value="{{ file.id }}">
                        <div class="file-icon">ğŸ“„</div>
                        <div class="file-info">
                            <div class="file-name">{{ file.file_name }}</div>
                            <div class="file-meta">{{ file.file_size_fmt }} â€¢ {{ file.created_at }}</div>
                        </div>
                        <div class="file-actions">
                            {% if file.is_large %}
                                <button class="btn" onclick="requestDownload([{{ file.id }}])">â¬‡ï¸ ì¤€ë¹„ ìš”ì²­</button>
                            {% else %}
                                <button class="btn" onclick="directDownload({{ file.file_id }}, '{{ file.file_name }}')">â¬‡ï¸ ë°›ê¸°</button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div style="text-align: center; padding: 40px; color: #aaa;">íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        const userId = {{ user_id }};
        
        // Upload Logic
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        
        dropZone.onclick = () => fileInput.click();
        
        fileInput.onchange = async (e) => handleUpload(e.target.files);
        
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = '#fff'; };
        dropZone.ondragleave = () => { dropZone.style.borderColor = 'rgba(255,255,255,0.3)'; };
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'rgba(255,255,255,0.3)';
            handleUpload(e.dataTransfer.files);
        };

        async function handleUpload(files) {
            if (!files.length) return;
            const status = document.getElementById('status-msg');
            
            for (let file of files) {
                status.textContent = `ì—…ë¡œë“œ ì¤‘: ${file.name}...`;
                const formData = new FormData();
                formData.append('file', file);
                formData.append('user_id', userId);
                
                try {
                    const res = await fetch('/api/files/upload', { method: 'POST', body: formData });
                    const data = await res.json();
                    if (!data.success) alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + data.message);
                } catch (e) {
                    console.error(e);
                    alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
                }
            }
            status.textContent = 'ì™„ë£Œ! ìƒˆë¡œê³ ì¹¨ ì¤‘...';
            location.reload();
        }

        // Direct Download (Small files)
        async function directDownload(fileId, fileName) {
            // Need a direct proxy endpoint or reuse /stream/ ?
            // Since we stored file_id in `files` table, we can use /download/ endpoint logic?
            // But /download/{short_id} expects a short_id from `shared_links`. 
            // We need a generic download endpoint for `file_id`. 
            // Currently server.py has /stream/{file_id} which proxies.
            // Let's use that for direct download.
            window.location.href = `/stream/${fileId}`; 
            // Actually stream endpoint might render in browser. 
            // Force download by creating a link with download attr?
            // Or create a new endpoint? 
            // Let's create an anchor tag.
            const a = document.createElement('a');
            a.href = `/stream/${fileId}`;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Request Download (Large/Multi)
        async function requestDownload(fileIds) {
            if (!fileIds.length) return alert('ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
            
            if (!confirm(`ë‹¤ìš´ë¡œë“œ ì¤€ë¹„ë¥¼ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (${fileIds.length}ê°œ)
ì¤€ë¹„ê°€ ì™„ë£Œë˜ë©´ í…”ë ˆê·¸ë¨ìœ¼ë¡œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.`)) return;

            try {
                const res = await fetch('/api/files/prepare-download', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ file_ids: fileIds, user_id: userId })
                });
                const data = await res.json();
                alert(data.message);
            } catch (e) {
                alert('ìš”ì²­ ì‹¤íŒ¨');
            }
        }

        function requestMultiDownload() {
            const selected = Array.from(document.querySelectorAll('.file-checkbox:checked')).map(cb => parseInt(cb.value));
            requestDownload(selected);
        }

        async function deleteSelected() {
            const selected = Array.from(document.querySelectorAll('.file-checkbox:checked')).map(cb => cb.value);
            if (!selected.length) return;
            if (!confirm('ì„ íƒí•œ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            for (let id of selected) {
                await fetch(`/api/files/${id}`, { 
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: userId})
                });
            }
            location.reload();
        }
    </script>
</body>
</html>