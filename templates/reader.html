<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ title }} - Reader</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#1a1a1a">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #1a1a1a;
            color: #ccc;
            font-family: sans-serif;
            height: 100vh;
            width: 100vw;
        }
        
        #viewer {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Loading Spinner */
        #loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            pointer-events: none;
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.1);
            border-left-color: #667eea;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Touch Zones */
        .touch-zone {
            position: absolute;
            top: 0; bottom: 0;
            z-index: 5;
            /* background: rgba(255,0,0,0.1); /* debug */ 
        }
        #prev-zone { left: 0; width: 30%; }
        #next-zone { right: 0; width: 30%; }
        #menu-zone { left: 30%; width: 40%; }

        /* Menu / Controls */
        #controls {
            position: absolute;
            top: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.9);
            padding: 15px;
            transform: translateY(-100%);
            transition: transform 0.3s;
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #controls.active {
            transform: translateY(0);
        }

        .control-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .back-btn {
            background: none; border: none; color: #fff; font-size: 18px; cursor: pointer;
            text-decoration: none; display: flex; align-items: center; gap: 5px;
        }

        .settings-panel {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.95);
            padding: 20px;
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 20;
            border-top: 1px solid #333;
        }
        .settings-panel.active {
            transform: translateY(0);
        }

        .setting-group { margin-bottom: 15px; }
        .setting-label { font-size: 12px; color: #888; margin-bottom: 8px; display: block; }
        
        .theme-options { display: flex; gap: 10px; }
        .theme-btn {
            flex: 1; padding: 10px; border: 1px solid #444; border-radius: 6px;
            cursor: pointer; text-align: center; font-size: 14px;
        }
        .theme-btn.active { border-color: #667eea; }
        
        /* Theme Colors */
        .theme-light { background: #fff; color: #000; }
        .theme-dark { background: #1a1a1a; color: #ccc; }
        .theme-sepia { background: #f4ecd8; color: #5b4636; }

        .font-size-ctrl { display: flex; align-items: center; gap: 15px; background: #333; padding: 5px; border-radius: 8px; }
        .fs-btn { background: none; border: none; color: #fff; font-size: 18px; width: 40px; cursor: pointer; }
        .fs-display { flex: 1; text-align: center; font-size: 14px; }

        select {
            width: 100%; padding: 10px; background: #333; border: none; color: #fff; border-radius: 6px;
        }

        /* Progress Bar */
        #progress-bar-container {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 4px;
            background: rgba(255,255,255,0.1);
            z-index: 10;
        }
        #progress-bar {
            height: 100%;
            background: #667eea;
            width: 0%;
            transition: width 0.2s;
        }
        #page-info {
            position: absolute;
            bottom: 10px; right: 10px;
            font-size: 12px; color: #888;
            pointer-events: none; z-index: 5;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
    </div>

    <!-- Viewer Container -->
    <div id="viewer"></div>

    <!-- Touch Zones -->
    <div id="prev-zone" class="touch-zone"></div>
    <div id="menu-zone" class="touch-zone"></div>
    <div id="next-zone" class="touch-zone"></div>

    <!-- Top Controls -->
    <div id="controls">
        <div class="control-row">
            <a href="/files/{{ user_id }}" class="back-btn">‚Üê Back</a>
            <span style="font-size: 14px; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ title }}</span>
            <button class="back-btn" onclick="toggleSettings()">Aa</button>
        </div>
    </div>

    <!-- Bottom Settings -->
    <div class="settings-panel" id="settings">
        <div class="setting-group">
            <span class="setting-label">Theme</span>
            <div class="theme-options">
                <div class="theme-btn theme-light" onclick="setTheme('light')">Light</div>
                <div class="theme-btn theme-sepia" onclick="setTheme('sepia')">Sepia</div>
                <div class="theme-btn theme-dark active" onclick="setTheme('dark')">Dark</div>
            </div>
        </div>
        <div class="setting-group">
            <span class="setting-label">Font Size</span>
            <div class="font-size-ctrl">
                <button class="fs-btn" onclick="changeFontSize(-1)">A-</button>
                <span class="fs-display" id="fs-val">100%</span>
                <button class="fs-btn" onclick="changeFontSize(1)">A+</button>
            </div>
        </div>
        <div class="setting-group">
            <span class="setting-label">Font Family</span>
            <select onchange="setFont(this.value)">
                <option value="Helvetica, sans-serif">Sans Serif</option>
                <option value="Georgia, serif">Serif</option>
                <option value="'Times New Roman', serif">Times New Roman</option>
                <option value="Arial, sans-serif">Arial</option>
            </select>
        </div>
    </div>

    <div id="progress-bar-container"><div id="progress-bar"></div></div>
    <div id="page-info"></div>

    <script>
        const bookUrl = "{{ book_url }}";
        const initialCfiStr = "{{ initial_cfi }}";
        const initialCfi = (initialCfiStr && initialCfiStr !== "None" && initialCfiStr !== "null") ? initialCfiStr : undefined;
        const fileId = {{ file_id }};
        const userId = {{ user_id }};

        // State
        let currentTheme = 'dark';
        let currentFontSize = 100;
        const themes = {
            light: { body: { background: '#fff', color: '#000' } },
            sepia: { body: { background: '#f4ecd8', color: '#5b4636' } },
            dark: { body: { background: '#1a1a1a', color: '#ccc' } }
        };

        // Fetch book as ArrayBuffer
        fetch(bookUrl)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.arrayBuffer();
            })
            .then(arrayBuffer => {
                // Initialize ePub with ArrayBuffer
                const book = ePub(arrayBuffer);
                const rendition = book.renderTo("viewer", {
                    width: "100%",
                    height: "100%",
                    flow: "paginated",
                    manager: "default"
                });

                // Assign to global for event handlers
                window.book = book;
                window.rendition = rendition;

                // Render
                const startPromise = initialCfi ? rendition.display(initialCfi) : rendition.display();
                
                startPromise.then(() => {
                    document.getElementById('loading').style.display = 'none';
                    applySettings();
                }).catch(err => {
                    console.warn('Display error with CFI, trying from beginning:', err);
                    rendition.display().then(() => {
                        document.getElementById('loading').style.display = 'none';
                        applySettings();
                    }).catch(fatalErr => {
                        console.error('Fatal display error:', fatalErr);
                        alert('Error rendering book: ' + fatalErr.message);
                    });
                });

                // Theme Registration
                rendition.themes.register("light", themes.light);
                rendition.themes.register("sepia", themes.sepia);
                rendition.themes.register("dark", themes.dark);

                // Navigation
                const prevZone = document.getElementById('prev-zone');
                const nextZone = document.getElementById('next-zone');
                const menuZone = document.getElementById('menu-zone');

                prevZone.addEventListener('click', () => rendition.prev());
                nextZone.addEventListener('click', () => rendition.next());
                menuZone.addEventListener('click', toggleMenu);

                // Keyboard support
                document.addEventListener('keyup', (e) => {
                    if ((e.keyCode || e.which) == 37) rendition.prev();
                    if ((e.keyCode || e.which) == 39) rendition.next();
                });

                // Progress Tracking
                rendition.on('relocated', (location) => {
                    const percent = location.start.percentage;
                    const cfi = location.start.cfi;
                    
                    // Update UI
                    if (document.getElementById('progress-bar')) {
                        document.getElementById('progress-bar').style.width = (percent * 100) + "%";
                    }

                    // Save to server
                    saveProgress(cfi, percent);
                });
            })
            .catch(err => {
                console.error('Download error:', err);
                alert('Failed to download book: ' + err.message);
                document.getElementById('loading').style.display = 'none';
            });

        // Menu Toggle
        function toggleMenu() {
            const controls = document.getElementById('controls');
            const settings = document.getElementById('settings');
            
            if (controls.classList.contains('active')) {
                controls.classList.remove('active');
                settings.classList.remove('active');
            } else {
                controls.classList.add('active');
            }
        }

        function toggleSettings() {
            document.getElementById('settings').classList.toggle('active');
        }

        // Settings Functions
        function setTheme(theme) {
            currentTheme = theme;
            if (window.rendition) {
                window.rendition.themes.select(theme);
                document.body.style.background = themes[theme].body.background;
            }
            
            // Update buttons
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains(`theme-${theme}`)) btn.classList.add('active');
            });
        }

        function changeFontSize(dir) {
            currentFontSize += (dir * 10);
            if (currentFontSize < 50) currentFontSize = 50;
            if (currentFontSize > 200) currentFontSize = 200;
            if (window.rendition) window.rendition.themes.fontSize(currentFontSize + "%");
            document.getElementById('fs-val').innerText = currentFontSize + "%";
        }

        function setFont(font) {
            if (window.rendition) window.rendition.themes.font(font);
        }

        function applySettings() {
            setTheme(currentTheme);
            changeFontSize(0); 
        }

        let saveTimeout;
        function saveProgress(cfi, percent) {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                fetch('/api/epub/progress', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: userId,
                        file_id: fileId,
                        cfi: cfi,
                        percent: percent * 100
                    })
                }).catch(err => console.error('Failed to save progress', err));
            }, 1000); 
        }
    </script>
</body>
</html>