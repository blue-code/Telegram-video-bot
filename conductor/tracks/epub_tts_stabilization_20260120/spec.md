# Track: EPUB TTS Stabilization and Comprehensive Testing

## 1. 개요 (Overview)
EPUB 리더의 TTS 기능에서 발생하는 심각한 안정성 문제(페이지 간 중복 읽기, 오디오 겹침, 자동 넘김 오류 등)를 해결합니다.
단순한 버그 수정을 넘어, 오디오 재생 상태를 엄격하게 관리하는 시스템을 구축하고, 다양한 레벨의 테스트(Unit, E2E, Scenario)를 통해 결함을 영구적으로 방지하는 것을 목표로 합니다.

## 2. 기능 요구사항 (Functional Requirements)

### 2.1 TTS 엔진 및 상태 관리 재설계 (Core)
1.  **단일 오디오 인스턴스 보장 (Singleton Audio Controller):**
    *   앱 전체에서 유일한 `AudioController` 클래스를 구현합니다.
    *   새로운 재생 요청 시 기존 재생을 즉시 중단(abort)하고 리소스를 해제합니다.
2.  **오디오 큐 시스템 (Audio Queue System):**
    *   TTS 요청을 큐(Queue)에 담아 순차적으로 처리합니다.
    *   페이지 넘김 등으로 인한 취소 요청 시 큐를 즉시 비우고 현재 작업을 취소합니다.
3.  **엄격한 이벤트 리스너 관리:**
    *   오디오 재생 시작/종료/에러 이벤트 리스너를 중앙에서 관리하며, 불필요한 리스너가 누적되지 않도록 `cleanup` 로직을 강화합니다.

### 2.2 페이지 간 텍스트 연결 로직 개선 (Text Extraction)
1.  **정밀한 Range CFI 계산:**
    *   `epub.js`의 `range` 기능을 활용하여, 현재 페이지의 시작점부터 끝점까지가 아닌, **실제 읽어야 할 문장의 시작점(이전 페이지 마지막 문장 끝)**부터 텍스트를 추출하도록 로직을 수정합니다.
2.  **중복 텍스트 필터링 (Double Safety):**
    *   추출된 텍스트가 이전 재생 텍스트의 마지막 부분과 중복되는지 검사하는 알고리즘을 추가하여, CFI 계산 오차로 인한 중복을 2차로 방지합니다.

### 2.3 자동 페이지 넘김 안정화 (Auto-Paging)
1.  **상태 기반 넘김 처리:**
    *   단순 타이머가 아닌, 오디오 재생 `ended` 이벤트를 신뢰성 있게 수신하여 다음 페이지 로딩을 트리거합니다.
    *   페이지 로딩 중에는 TTS 요청을 대기 상태(Pending)로 유지합니다.

## 3. 테스트 및 검증 요구사항 (Testing & Verification)

### 3.1 단위 테스트 (Unit Tests) - Jest/Vitest
*   **텍스트 추출 로직:** 다양한 CFI 범위에 대해 올바른 텍스트가 추출되는지 검증.
*   **중복 제거 알고리즘:** 중복된 문자열이 포함된 입력에 대해 필터링이 정상 동작하는지 검증.
*   **큐 시스템:** 큐에 작업 추가, 취소, 순차 실행 로직 검증.

### 3.2 E2E/통합 테스트 (E2E Tests) - Playwright
*   **시날리오:** 책 열기 -> TTS 재생 -> 3페이지 이상 자동 넘김 확인.
*   **검증:** 오디오 태그의 `src` 변경 로그, 페이지 넘김 이벤트, 브라우저 콘솔 에러 감지.
*   **동시성 테스트:** 빠른 페이지 넘김 시 오디오가 겹치지 않는지 확인.

### 3.3 시나리오 기반 로깅 및 수동 검증
*   **디버그 모드:** TTS 상태(재생 중, 대기 중, 읽은 문장 등)를 화면에 표시하는 디버그 패널 추가.
*   **로그 추적:** 재생된 문장의 해시(Hash)를 로그로 남겨 중복 재생 여부를 쉽게 파악하도록 함.

## 4. 비기능 요구사항 (Non-Functional Requirements)
*   **반응성:** TTS 재생 버튼 클릭 후 1초 이내에 피드백(로딩 등)이 있어야 합니다.
*   **안정성:** 네트워크 지연 등으로 TTS 생성이 늦어질 때 UI가 멈추지 않아야 합니다.

## 5. 수용 기준 (Acceptance Criteria)
*   [ ] 1페이지부터 5페이지까지 TTS 자동 재생 시, 문장이 중복되거나 건너뛰는 현상이 없어야 한다.
*   [ ] 재생 중 사용자가 강제로 페이지를 넘기면 즉시 이전 오디오가 멈추고 새 페이지를 읽어야 한다(목소리 겹침 없음).
*   [ ] 자동화 테스트(Unit, E2E)가 모두 통과해야 한다.
