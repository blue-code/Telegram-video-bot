# Gemini Context for Telegram Video Bot (TVB)

This `GEMINI.md` file provides essential context for the Telegram Video Bot project. Use this information to understand the project structure, run commands, and adhere to development conventions.

## 1. Project Overview

**TVB (Telegram Video Bot)** is a comprehensive solution for downloading, storing, and streaming videos via Telegram. It allows users to send video URLs (like YouTube) to a Telegram bot, which downloads the content, uploads it to a "Bin Channel" (acting as unlimited cloud storage), and makes it available for streaming via a modern web interface.

**Key Features:**
*   **Download:** Supports YouTube and 1000+ sites via `yt-dlp`.
*   **Storage:** Uses a private Telegram channel ("Bin Channel") to store video files indefinitely.
*   **Streaming:** FastAPI-based web server for streaming videos directly from Telegram servers (proxying) or via file ID reuse.
*   **Splitting:** Automatically splits large files (>2GB) using `ffmpeg` to bypass Telegram limits.
*   **Management:** Web dashboard for gallery, favorites, search, and statistics.
*   **Database:** Stores metadata, user info, and file references in **Supabase** (PostgreSQL).

## 2. Tech Stack

*   **Language:** Python 3.12+
*   **Bot Framework:** `python-telegram-bot` (Async)
*   **Web Framework:** `FastAPI`, `Uvicorn`, `Jinja2` (Templates)
*   **Database:** `Supabase` (PostgreSQL) - *Note: Early docs mention MongoDB, but the codebase uses Supabase.*
*   **Video Engines:** `yt-dlp` (Download), `ffmpeg` (Processing/Splitting)
*   **Testing:** `pytest`, `pytest-asyncio`

## 3. Project Structure

```text
C:\DEV\Python\Telegram-video-bot\
├── conductor/              # Project documentation and architectural plans
├── migrations/             # SQL migration files for Supabase
├── src/                    # Source code
│   ├── bot.py              # Main Telegram bot entry point
│   ├── db.py               # Database interaction layer (Supabase)
│   ├── downloader.py       # Video downloading logic (yt-dlp)
│   ├── server.py           # Web server (FastAPI) implementation
│   ├── splitter.py         # Video splitting logic (ffmpeg)
│   ├── user_manager.py     # User quotas and management
│   └── ...
├── static/                 # Static assets (JS, CSS, PWA)
├── templates/              # HTML templates (Jinja2) for the web UI
├── tests/                  # Unit and integration tests
├── .env                    # Environment variables (not committed)
├── requirements.txt        # Python dependencies
└── README.md               # General project documentation
```

## 4. Building and Running

### Prerequisites
*   Python 3.12+
*   FFmpeg (must be in system PATH)
*   Supabase account and project URL/Key
*   Telegram Bot Token

### Setup
1.  **Environment:** Ensure `.env` is configured with `TELEGRAM_BOT_TOKEN`, `SUPABASE_URL`, `SUPABASE_KEY`, and `BIN_CHANNEL_ID`.
2.  **Dependencies:** `pip install -r requirements.txt`

### Execution Commands
*   **Run Bot:**
    ```bash
    python -m src.bot
    ```
*   **Run Web Server:**
    ```bash
    uvicorn src.server:app --host 0.0.0.0 --reload --port 8000
    ```
    *   *Note:* `start_all.bat` likely combines these or similar commands for Windows.

### Testing
*   **Run All Tests:**
    ```bash
    pytest tests/ -v
    ```
*   **Manual Verification:** Use provided scripts like `run_verify.bat` or `verify_phaseX.py` scripts for specific feature verification.

### Database Migrations
*   **Run Migrations:**
    ```bash
    python migrations/run_migrations.py
    ```
    *   *Note:* This script typically outputs SQL to be executed in the Supabase SQL Editor.

## 5. Development Conventions

*   **Code Style:** Follow standard Python PEP 8 conventions.
*   **Async/Await:** The project relies heavily on `asyncio` for both the bot and web server. Ensure new IO-bound operations are non-blocking.
*   **Error Handling:** Use `logger.error` for exceptions. The bot should notify users of failures gracefully.
*   **File Handling:** Large files must be split. `MAX_WEB_UPLOAD_SIZE` in `src/server.py` is set to 15MB for web uploads (Telegram limitation), but the bot handles larger downloads via splitting.
*   **Verification:** Use the `tests/` directory for regression testing.

## 6. Critical Files to Watch

*   `src/server.py`: Contains the core logic for the web interface and streaming proxy.
*   `src/bot.py`: Handles Telegram events.
*   `src/db.py`: Central point for all database queries. Changes here affect the entire app.
*   `.env`: Configuration source.

This file is automatically generated to provide context for the Gemini agent.
